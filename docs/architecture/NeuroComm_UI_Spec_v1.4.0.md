# NeuroComm UI Specification — v1.4.0

> **Связанные документы:**
> - `01_2026_NC_architecture_v1.4.0.md` (архитектура, разделы 4.2, 5.1–5.3)
> - `NeuroComm_State_Diagrams_v1.4.0.md` (state diagrams, маркеры)
> - `UART_Protocol_Spec_v1.4.0.md` (протокол MCU2↔MCU3)
>
> **Платформа:** MCU3 (STM32), OLED/LCD дисплей, 4-позиционный джойстик
> **Базовый документ:** 2025_NeuroComm_UI.pdf (Keln demo box)

---

## 1. Общая структура дисплея

Дисплей разделён на фиксированные зоны:

```
┌─────────────────────────────────────────┐
│ [Vdd] │ v.X.Y.Z    RX/TX : MODE        │  ← Header (всегда)
├─────────────────────────────────────────┤
│                                         │
│         STATUS FRAME (основное)         │  ← Контент
│                                         │
├─────────────────────────────────────────┤
│                              Config ▷   │  ← Footer (навигация)
└─────────────────────────────────────────┘
```

### 1.1 Header (верхняя строка, всегда видна)

| Поле | Формат | Источник | Описание |
|------|--------|----------|----------|
| Vdd | `3.15` | MCU3 ADC | Напряжение питания. Цвет/иконка по порогам (см. 6.1) |
| Version | `v.X.Y.Z` | FW version | Версия прошивки MCU3 |
| RX/TX | `RX` или `TX` | MCU2 → MCU3 | Текущее направление: RX (приём) или TX (передача) |
| MODE | `AI-VOX` / `AI-PRO` / `AI-PRO+SR` | MCU2 → MCU3 или MCU3 config | Текущий активный режим |

### 1.2 Status Frame (основная область)

Содержимое зависит от контекста:
- **Рабочий экран** — отображение статуса в реальном времени (по умолчанию)
- **Меню SERVICE** — навигация по настройкам (по входу через джойстик)

### 1.3 Footer

- `Config ▷` — подсказка: джойстик вправо → SERVICE menu
- В SERVICE: `◁ Back` / `Change ▷` — навигация

---

## 2. Рабочие экраны по режимам

### 2.1 Экран RX (приём — состояние по умолчанию)

Дисплей при PTT=OFF (приём радио). Это **стартовый экран** после загрузки.

**AI-VOX:**
```
┌─────────────────────────────────────────┐
│ 3.15 │ v1.0.0         RX : AI-VOX      │
├─────────────────────────────────────────┤
│                                         │
│           RECEIVING SIGNAL              │
│                                         │
│           RECEIVE VE                    │
│                                         │
├─────────────────────────────────────────┤
│                              Config ▷   │
└─────────────────────────────────────────┘
```

**AI-VOX PRO:**
```
┌─────────────────────────────────────────┐
│ 3.15 │ v1.0.0         RX : AI-PRO      │
├─────────────────────────────────────────┤
│                                         │
│           RECEIVING SIGNAL              │
│           RECEIVE VE                    │
│           CHANNEL ALPHA                 │
│                                         │
├─────────────────────────────────────────┤
│                              Config ▷   │
└─────────────────────────────────────────┘
```

**AI-VOX PRO + SR:**
```
┌─────────────────────────────────────────┐
│ 3.15 │ v1.0.0         RX : AI-PRO+SR   │
├─────────────────────────────────────────┤
│                                         │
│           RECEIVING SIGNAL              │
│           RECEIVE VE                    │
│           SPEAKER KNOWN                 │
│           CHANNEL ALPHA                 │
│                                         │
├─────────────────────────────────────────┤
│                              Config ▷   │
└─────────────────────────────────────────┘
```

### 2.2 Экран TX (передача)

Дисплей при PTT=ON (передача радио). Переход RX→TX происходит по VAD Start (AI-VOX) или по VAD Start в активной сессии (PRO/PRO+SR).

**AI-VOX:**
```
┌─────────────────────────────────────────┐
│ 3.15 │ v1.0.0         TX : AI-VOX      │
├─────────────────────────────────────────┤
│                                         │
│           VOICE                         │
│           PTT AUTO                      │
│           TRANSMIT VE                   │
│                                         │
├─────────────────────────────────────────┤
│                              Config ▷   │
└─────────────────────────────────────────┘
```

**AI-VOX PRO:**
```
┌─────────────────────────────────────────┐
│ 3.15 │ v1.0.0         TX : AI-PRO      │
├─────────────────────────────────────────┤
│                                         │
│           VOICE          PTT AUTO       │
│           TRANSMIT VE                   │
│           CHANNEL ALPHA                 │
│           DCS 023N                      │
│                                         │
├─────────────────────────────────────────┤
│                              Config ▷   │
└─────────────────────────────────────────┘
```

**AI-VOX PRO + SR:**
```
┌─────────────────────────────────────────┐
│ 3.15 │ v1.0.0         TX : AI-PRO+SR   │
├─────────────────────────────────────────┤
│                                         │
│           VOICE          PTT AUTO       │
│           SPEAKER KNOWN                 │
│           TRANSMIT VE                   │
│           CHANNEL ALPHA                 │
│           DCS 023N                      │
│                                         │
├─────────────────────────────────────────┤
│                              Config ▷   │
└─────────────────────────────────────────┘
```

---

## 3. Статусные элементы (Status Fields)

### 3.1 VAD Status

| Значение | Отображение | Условие |
|----------|-------------|---------|
| NO-VOICE | `NO-VOICE` / скрыто | VAD=OFF (тишина) |
| VOICE | `VOICE` | VAD=ON (голос обнаружен) |

В режиме RX поле VAD не отображается (VAD работает только на MIC path).
В режиме TX: VOICE отображается при активной передаче.

### 3.2 PTT Status

| Значение | Отображение | Условие |
|----------|-------------|---------|
| PTT MANUAL | `PTT MANUAL` | Ручной режим (hardware PTT button) |
| PTT AUTO | `PTT AUTO` | AI-VOX / AI-PRO / AI-PRO+SR (VAD-управление) |

### 3.3 VE Status

| Значение | Отображение | Условие |
|----------|-------------|---------|
| RECEIVE VE | `RECEIVE VE` | RX режим, VE обрабатывает входящий сигнал |
| TRANSMIT VE | `TRANSMIT VE` | TX режим, VE обрабатывает исходящий сигнал |
| ALWAYS-ON VE | `ALWAYS-ON VE` | VE работает непрерывно (RX и TX) |

> **Отображается только при VE=ON.** Если VE выключен — поле скрыто.

### 3.4 KWS Status (только AI-PRO и AI-PRO+SR)

| Значение | Отображение | Условие | Соответствие KWS cmd |
|----------|-------------|---------|---------------------|
| CHANNEL ALPHA | `CHANNEL ALPHA` | KWS cmd 1 обнаружена | cmd 1 (стартовая) |
| CHANNEL BRAVO | `CHANNEL BRAVO` | KWS cmd 2 обнаружена | cmd 2 (стартовая) |
| CHANNEL DELTA | `CHANNEL DELTA` | KWS cmd 3 обнаружена | cmd 3 (стартовая) |
| DISCONNECT | `DISCONNECT` | KWS cmd 4 обнаружена | cmd 4 (disconnect) |

Канал отображается на протяжении всей активной сессии. При disconnect — кратковременно показывается DISCONNECT, затем экран переходит в RX.

### 3.5 SR Status (только AI-PRO+SR)

| Значение | Отображение | Время показа | Условие |
|----------|-------------|--------------|---------|
| SPEAKER KNOWN | `SPEAKER KNOWN` | Пока сессия активна | SR=true, авторизация пройдена |
| SPEAKER UNKNOWN | `SPEAKER UNKNOWN` | 1 сек | SR timeout expired (авторизация не успела) |
| NO SPEAKER | `NO SPEAKER` | 1 сек | SR модель не обучена |
| SR false | — (кратковременно) | 1 сек | SR=false, говорящий не подтверждён → возврат в RX |

> **SPEAKER status показывается 1 сек** после обработки SR, затем:
> - SR=true → остаётся SPEAKER KNOWN на весь сеанс
> - SR=false → показ 1 сек → возврат в RX (ожидание)

### 3.6 DCS Code (опционально)

| Значение | Отображение | Условие |
|----------|-------------|---------|
| DCS code | `DCS 023N` (пример) | TX режим, PRO/PRO+SR, цифровой код радиоканала |

---

## 4. Таблица переходов дисплея

### 4.1 Основные переходы (событие → экран)

| # | Событие (от MCU2) | Header RX/TX | Статусные поля | Beep | Примечание |
|---|-------------------|-------------|----------------|------|------------|
| 1 | Boot / Power ON | — | `Booting...` | — | Загрузка, инициализация |
| 2 | Boot OK | `RX : <MODE>` | Рабочий экран RX | — | Режим по умолчанию = RX |
| 3 | Boot Error | — | `ERROR` | — | Ошибка инициализации |
| 4 | `VAD_ON` (AI-VOX) | `TX : AI-VOX` | VOICE, PTT AUTO, TRANSMIT VE | — | VAD Start → PTT ON → TX |
| 5 | `VAD_OFF` (AI-VOX) | `RX : AI-VOX` | RX экран | — | VAD Stop → PTT OFF → RX |
| 6 | `CMD_DETECTED: 1` | — (остаётся RX) | CHANNEL ALPHA (flash) | ✅ beep confirm | KWS нашёл команду. Session Active, PTT OFF |
| 7 | `CMD_DETECTED: 2` | — | CHANNEL BRAVO (flash) | ✅ beep confirm | Аналогично cmd 1 |
| 8 | `CMD_DETECTED: 3` | — | CHANNEL DELTA (flash) | ✅ beep confirm | Аналогично cmd 1 |
| 9 | `SESSION_ACTIVE` | `RX : <MODE>` | CHANNEL xxx + Session indicator | ✅ beep session | Сессия активна, PTT OFF, ожидание VAD |
| 10 | `SR_CONFIRMED` | — | SPEAKER KNOWN | ✅ beep confirm | Только PRO+SR. SR=true |
| 11 | `SR_REJECTED` | — | SPEAKER UNKNOWN (1 сек) | ✅ beep reject | Только PRO+SR. SR=false → возврат |
| 12 | `VAD_ON` (в сессии) | `TX : <MODE>` | VOICE, PTT AUTO, TRANSMIT VE, CHANNEL | — | PTT ON в активной сессии |
| 13 | `VAD_OFF` (в сессии) | `RX : <MODE>` | RX экран + CHANNEL (сессия жива) | — | PTT OFF (пауза), сессия не закрывается |
| 14 | `SESSION_CLOSED` (cmd 4) | `RX : <MODE>` | DISCONNECT (1 сек) → RX | ✅ beep disconnect | Disconnect, полный сброс |
| 15 | `SESSION_TIMEOUT` | `RX : <MODE>` | TIMEOUT (1 сек) → RX | ✅ beep timeout | Session Timeout (30 сек тишины) |
| 16 | `BATTERY_LOW` | — | `BATTERY LOW / CHARGE BATTERY` | — | Vdd < порога (см. 6.1) |

### 4.2 Последовательность экранов — AI-VOX PRO (полный цикл)

```
[RX: AI-PRO]                        ← Ожидание
     │
     ▼ VAD_ON
[RX: AI-PRO] + VOICE               ← MCU1 VAD, аудио → MCU2 → Sensory
     │
     ▼ CMD_DETECTED: 1 + beep
[RX: AI-PRO] + CHANNEL ALPHA       ← Session Active, PTT OFF
     │                                 (человек молчит, слышит RX)
     │                                 Session Timeout timer = 30 сек
     ▼ VAD_ON
[TX: AI-PRO] + VOICE + PTT AUTO    ← PTT ON, передача
     │         + CHANNEL ALPHA
     │         + TRANSMIT VE
     │
     ▼ VAD_OFF
[RX: AI-PRO] + CHANNEL ALPHA       ← PTT OFF (пауза), сессия жива
     │                                 RX активен (half-duplex)
     ▼ VAD_ON
[TX: AI-PRO] + VOICE + PTT AUTO    ← PTT ON снова
     │
     ▼ CMD 4 (disconnect) + beep
[RX: AI-PRO] + DISCONNECT (1 сек)  ← Полный сброс
     │
     ▼
[RX: AI-PRO]                        ← Ожидание (начальное)
```

### 4.3 Последовательность экранов — AI-VOX PRO + SR (полный цикл)

```
[RX: AI-PRO+SR]                     ← Ожидание
     │
     ▼ VAD_ON → CMD_DETECTED: 2 + beep
[RX: AI-PRO+SR] + CHANNEL BRAVO    ← KWS нашёл команду
     │
     ▼ SR verify...
     ├── SR_CONFIRMED + beep
     │   [RX: AI-PRO+SR] + SPEAKER KNOWN + CHANNEL BRAVO  ← Session Active
     │        │
     │        ▼ VAD_ON → TX (аналогично PRO)
     │        ...
     │
     └── SR_REJECTED + beep (reject tone)
         [RX: AI-PRO+SR] + SPEAKER UNKNOWN (1 сек)  ← Отказ
              │
              ▼
         [RX: AI-PRO+SR]            ← Возврат в ожидание
```

---

## 5. Beep Feedback (звуковые сигналы)

Beep генерируется на MCU2 (синтез тона), выводится в наушник. Не конфликтует с аудио потоком.

| # | Событие | Тон | Длительность | Частота (ориентир) |
|---|---------|-----|--------------|-------------------|
| 1 | KWS cmd 1–3 обнаружена | Подтверждение | ~100 мс | Два коротких высоких тона |
| 2 | SR = true | Подтверждение | ~150 мс | Восходящий тон |
| 3 | SR = false | Отказ | ~200 мс | Нисходящий тон |
| 4 | Session Active | Сессия | ~100 мс | Один средний тон |
| 5 | Disconnect (cmd 4) | Закрытие | ~150 мс | Два нисходящих тона |
| 6 | Session Timeout | Таймаут | ~300 мс | Три коротких низких тона |
| 7 | Error | Ошибка | ~500 мс | Длинный низкий тон |

> **Важно:** Тоны должны быть различимы на слух. Подтверждение = высокий, отказ = низкий, таймаут = повторяющийся. Конкретные частоты и длительности подбираются при тестировании.

---

## 6. SERVICE Menu (настройки)

### 6.1 Навигация

Вход: джойстик **вправо** из любого рабочего экрана (RX или TX).
Выход: джойстик **влево** — сохранение и возврат на рабочий экран.

```
SERVICE
├── Mode: [AI-VOX / AI-PRO / AI-PRO+SR]     ← Вверх/Вниз = выбор, Вправо = применить
├── Transmission VE: [ON / OFF]               ← VE для TX path
├── Receiving VE: [ON / OFF]                  ← VE для RX path
└── SR: Config → Start Record Voice           ← Только для AI-PRO+SR
```

### 6.2 Экраны SERVICE

**Экран 1 — Mode (курсор на Mode):**
```
┌─────────────────────────────────────────┐
│ 3.15 │              SERVICE             │
├─────────────────────────────────────────┤
│                                         │
│  ► Mode: AI-VOX PRO                    │
│    Transmission VE: ON/OFF              │
│    Receiving VE: ON/OFF                 │
│                                         │
├─────────────────────────────────────────┤
│ ◁ Back              ▲▼         Change ▷ │
└─────────────────────────────────────────┘
```

**Экран 2 — Transmission VE (курсор на VE TX):**
```
┌─────────────────────────────────────────┐
│ 3.15 │              SERVICE             │
├─────────────────────────────────────────┤
│                                         │
│    Mode: AI-VOX PRO                     │
│  ► Transmission VE: ON/OFF              │
│    Receiving VE: ON/OFF                 │
│                                         │
├─────────────────────────────────────────┤
│ ◁ Back              ▲▼         Change ▷ │
└─────────────────────────────────────────┘
```

**Экран 3 — Receiving VE:**
```
┌─────────────────────────────────────────┐
│ 3.15 │              SERVICE             │
├─────────────────────────────────────────┤
│                                         │
│    Mode: AI-VOX PRO                     │
│    Transmission VE: ON/OFF              │
│  ► Receiving VE: ON/OFF                 │
│                                         │
├─────────────────────────────────────────┤
│ ◁ Back              ▲▼         Change ▷ │
└─────────────────────────────────────────┘
```

### 6.3 Логика навигации SERVICE

| Действие | Функция |
|----------|---------|
| **▲ Вверх** | Перемещение курсора на строку выше |
| **▼ Вниз** | Перемещение курсора на строку ниже |
| **▷ Вправо (Change)** | Переключение значения (Mode: cycle через AI-VOX → AI-PRO → AI-PRO+SR; VE: toggle ON/OFF) |
| **◁ Влево (Back)** | Сохранить все изменения, отправить конфигурацию MCU2, вернуться на рабочий экран |

### 6.4 Применение изменений

При выходе из SERVICE (◁ Back) MCU3:
1. Сохраняет выбранную конфигурацию в NVM (non-volatile memory)
2. Отправляет MCU2 команду смены режима:
   - `CMD_SET_MODE(mode=<selected_mode>)`
   - `CMD_SET_VE(tx=<ON/OFF>, rx=<ON/OFF>)`
3. MCU2 применяет изменения, перенастраивает MCU1 при необходимости
4. Дисплей переходит на рабочий экран с обновлённым режимом

### 6.5 SR Config (только AI-PRO+SR)

При выборе SR → Config → Start Record Voice:
1. MCU3 отправляет MCU2 команду начала записи SR образца
2. MCU2 записывает голосовой образец через MIC → MCU1
3. По завершении MCU2 отправляет результат MCU3
4. Дисплей показывает статус: `Recording...` → `SR Model Updated` / `SR Record Failed`

---

## 7. Battery / Power Indicator

### 7.1 Пороги напряжения (Vdd от ADC MCU3)

| Vdd | Иконка/цвет | Состояние |
|-----|-------------|-----------|
| > 3.12 V | Зелёный / полная | Нормальное |
| 3.10–3.12 V | Жёлтый / средняя | Низкий заряд |
| ≤ 3.10 V | Красный / пустая | Критический — `BATTERY LOW` |

### 7.2 Экран BATTERY LOW

При Vdd ≤ 3.10 V дисплей переключается на предупреждение:

```
┌─────────────────────────────────────────┐
│ 3.10 │           BATTERY LOW            │
├─────────────────────────────────────────┤
│                                         │
│                                         │
│            CHARGE BATTERY               │
│                                         │
│                                         │
└─────────────────────────────────────────┘
```

> **Примечание:** При критическом уровне батареи вся обработка (VAD, KWS, SR) должна быть остановлена. MCU3 сигнализирует MCU2 о переходе в low-power mode.

---

## 8. Экран загрузки (Boot Sequence)

### 8.1 Нормальная загрузка

```
┌─────────────────────────────────────────┐
│                                         │
│                                         │
│             Booting...                  │
│                                         │
│                                         │
└─────────────────────────────────────────┘
```
→ после инициализации MCU1, MCU2, MCU3 → рабочий экран RX

### 8.2 Ошибка загрузки

```
┌─────────────────────────────────────────┐
│                                         │
│                                         │
│              ERROR                      │
│                                         │
│                                         │
└─────────────────────────────────────────┘
```

---

## 9. Сводная таблица: какие поля видны на каком экране

| Поле | AI-VOX RX | AI-VOX TX | AI-PRO RX | AI-PRO TX | AI-PRO+SR RX | AI-PRO+SR TX | SERVICE |
|------|-----------|-----------|-----------|-----------|-------------- |--------------|---------|
| Vdd | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| Version | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | — |
| RX/TX | RX | TX | RX | TX | RX | TX | — |
| MODE | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ (editable) |
| VOICE / NO-VOICE | — | VOICE | — | VOICE | — | VOICE | — |
| PTT AUTO | — | ✅ | — | ✅ | — | ✅ | — |
| VE status | Если VE ON | Если VE ON | Если VE ON | Если VE ON | Если VE ON | Если VE ON | ✅ (editable) |
| CHANNEL | — | — | При сессии | ✅ | При сессии | ✅ | — |
| SPEAKER | — | — | — | — | При SR done | ✅ | — |
| DCS code | — | — | — | ✅ | — | ✅ | — |

---

## 10. Привязка к событиям MCU2 → MCU3

| Сообщение MCU2 | Действие MCU3 (дисплей) | Действие MCU3 (beep relay) |
|----------------|------------------------|---------------------------|
| `CMD_DETECTED: cmd_id` | Показать CHANNEL (Alpha/Bravo/Delta по cmd_id) | MCU2 генерирует beep |
| `SR_CONFIRMED` | Показать SPEAKER KNOWN | MCU2 генерирует beep |
| `SR_REJECTED` | Показать SPEAKER UNKNOWN (1 сек) → вернуть RX | MCU2 генерирует beep (reject) |
| `SESSION_ACTIVE` | Показать индикатор сессии + CHANNEL | MCU2 генерирует beep |
| `SESSION_CLOSED` | Показать DISCONNECT/TIMEOUT (1 сек) → RX | MCU2 генерирует beep |
| `SESSION_TIMEOUT` | Показать TIMEOUT (1 сек) → RX | MCU2 генерирует beep (timeout) |
| `VAD_ON` | Header → TX, показать VOICE + PTT AUTO | — |
| `VAD_OFF` | Header → RX, убрать VOICE + PTT AUTO | — |
| `BATTERY_LOW` | Переключить на экран BATTERY LOW | — |
| `MODE_CHANGED: mode` | Обновить MODE в header | — |
| `VE_STATUS: tx, rx` | Обновить отображение VE | — |

---

## 11. Ключевые принципы UI

1. **Экран по умолчанию = RX.** Система стартует в режиме приёма. TX только при VAD→PTT.

2. **Half-duplex визуализация.** RX и TX взаимоисключающие. Header однозначно показывает текущее направление.

3. **Session Active ≠ TX.** В PRO/PRO+SR после KWS cmd дисплей остаётся в RX (человек слышит входящее), но показывает CHANNEL. TX — только при VAD Start.

4. **Beep = MCU2.** Дисплей не генерирует звук. MCU2 синтезирует тоны и выдаёт в наушник. MCU3 только отображает.

5. **Временные статусы (1 сек).** SR_REJECTED, DISCONNECT, TIMEOUT показываются кратковременно, затем автоматически сбрасываются на RX.

6. **VE отображается только при VE=ON.** Если VE выключен — строка VE отсутствует на экране (не мешает).

7. **SERVICE доступен из любого рабочего экрана.** Джойстик вправо → SERVICE, влево → сохранить и вернуться.

---

## Changelog

| Версия | Дата | Изменения |
|--------|------|-----------|
| 1.0 | 2025-02-08 | Первоначальная версия. Создана на основе Keln UI (2025_NeuroComm_UI.pdf) и NC_UI.md, синхронизирована с архитектурой v1.3.5 и state diagrams v1.3.5. Добавлены: Session Active экран (PTT OFF + CHANNEL), Session Timeout визуализация, half-duplex RX/TX индикация, beep feedback таблица, SERVICE menu с VE TX/RX раздельно. |
